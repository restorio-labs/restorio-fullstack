name: TypeScript Setup
description: "Setup TypeScript environment"

runs:
  using: composite
  steps:
    - name: Read Bun version from package.json
      shell: bash
      run: |
        BUN_VERSION=$(jq -r '.packageManager' package.json | sed 's/^bun@//')
        if [[ -z "$BUN_VERSION" || "$BUN_VERSION" == "null" ]]; then
          echo "âŒ packageManager not found or invalid in package.json"
          exit 1
        fi
        echo "BUN_VERSION=$BUN_VERSION" >> $GITHUB_ENV

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      shell: bash
      run: |
        set -e

        bun install

        for app in apps/*; do
          if [ "$app" != "apps/api" ] && [ -d "$app" ]; then
            echo "ðŸ“¦ Installing dependencies for $app..."
            (cd "$app" && bun install --frozen-lockfile)
          fi
        done

        for package in packages/*; do
          if [ -d "$package" ]; then
            echo "ðŸ“¦ Installing dependencies for $package..."
            (cd "$package" && bun install --frozen-lockfile)
          fi
        done

    - name: Build apps and packages
      shell: bash
      run: bun run build

    - name: Format check in all packages and apps
      shell: bash
      run: bun run check

    - name: Unit tests apps and packages
      shell: bash
      run: bun run test:unit

    - name: Generate coverage report
      shell: bash
      run: bun run coverage:report
